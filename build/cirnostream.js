!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).CirnoStream=t()}(this,(function(){"use strict";function ownKeys(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function _createClass(e,t,r){return t&&_defineProperties(e.prototype,t),r&&_defineProperties(e,r),e}function _defineProperty(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _slicedToArray(e,t){return function _arrayWithHoles(e){if(Array.isArray(e))return e}(e)||function _iterableToArrayLimit(e,t){var r=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null==r)return;var n,i,a=[],o=!0,s=!1;try{for(r=r.call(e);!(o=(n=r.next()).done)&&(a.push(n.value),!t||a.length!==t);o=!0);}catch(e){s=!0,i=e}finally{try{o||null==r.return||r.return()}finally{if(s)throw i}}return a}(e,t)||_unsupportedIterableToArray(e,t)||function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?_arrayLikeToArray(e,t):void 0}}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function _classPrivateFieldGet(e,t){return function _classApplyDescriptorGet(e,t){if(t.get)return t.get.call(e);return t.value}(e,_classExtractFieldDescriptor(e,t,"get"))}function _classPrivateFieldSet(e,t,r){return function _classApplyDescriptorSet(e,t,r){if(t.set)t.set.call(e,r);else{if(!t.writable)throw new TypeError("attempted to set read only private field");t.value=r}}(e,_classExtractFieldDescriptor(e,t,"set"),r),r}function _classExtractFieldDescriptor(e,t,r){if(!t.has(e))throw new TypeError("attempted to "+r+" private field on non-instance");return t.get(e)}function _classPrivateMethodGet(e,t,r){if(!t.has(e))throw new TypeError("attempted to get private field on non-instance");return r}function _checkPrivateRedeclaration(e,t){if(t.has(e))throw new TypeError("Cannot initialize the same private elements twice on an object")}function _classPrivateFieldInitSpec(e,t,r){_checkPrivateRedeclaration(e,t),t.set(e,r)}function _classPrivateMethodInitSpec(e,t){_checkPrivateRedeclaration(e,t),t.add(e)}var e=function getUUID(){var e;"undefined"!=typeof crypto&&crypto.getRandomValues&&(e=crypto.getRandomValues.bind(crypto)),"undefined"!=typeof msCrypto&&"function"==typeof msCrypto.getRandomValues&&(e=msCrypto.getRandomValues.bind(msCrypto));for(var t=[3,5,7,9],r=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i,n=/^(?:[0-9a-f]{8}[0-9a-f]{4}[1-5][0-9a-f]{3}[89ab][0-9a-f]{3}[0-9a-f]{12}|00000000000000000000000000000000)$/i,i=[],a=0;a<256;++a)i.push((a+256).toString(16).substr(1));return function(a){if(!e)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");var o=e(new Uint8Array(16)),s="";o[6]=15&o[6]|64,o[8]=63&o[8]|128;for(var l=0;l<16;++l)s+=i[o[l]],!a&&t.indexOf(l)>=0&&(s+="-");if(a&&"string"==typeof s&&n.test(s))return s;if("string"==typeof s&&r.test(s))return s;throw TypeError("Stringified UUID is invalid")}}();function CallbackEvent(e,t){return{type:t,name:e.name,delay:e.delay,onProccess:e.onProccess,repeat:e.repeat,remain:e.remain,createTime:e.createTime,runtime:e.runtime,isLoopEvent:e.isLoopEvent,close:e.close,freeze:e.freeze,release:e.release}}function StreamExcution(e,t){if(!e.onProccess&&(t.runTime-e.createTime)*t.delay>=e.delay){var r=e.eventList.length,n=r>0?e.eventList.shift():e.handler;if(e.isLoopEvent&&r>0&&n&&e.eventList.push(n),(e.isLoopEvent||e.remain>0)&&"function"==typeof n)try{n(CallbackEvent(e,"excute"))}catch(e){console.error(e)}e.refresh(e),!e.isLoopEvent&&e.decrease(e)}}var t=new WeakMap,r=function(){function StreamTimer(){_classCallCheck(this,StreamTimer),_classPrivateFieldInitSpec(this,t,{writable:!0,value:void 0}),_classPrivateFieldSet(this,t,0)}return _createClass(StreamTimer,[{key:"counter",get:function get(){return _classPrivateFieldGet(this,t)}},{key:"count",value:function count(){return _classPrivateFieldSet(this,t,_classPrivateFieldGet(this,t)+1),_classPrivateFieldGet(this,t)}},{key:"reset",value:function reset(){_classPrivateFieldSet(this,t,0)}}]),StreamTimer}(),n=new WeakMap,i=new WeakMap,a=function(){function StreamEvent(e,t){_classCallCheck(this,StreamEvent),_classPrivateFieldInitSpec(this,n,{writable:!0,value:void 0}),_classPrivateFieldInitSpec(this,i,{writable:!0,value:void 0}),_classPrivateFieldSet(this,i,e),_classPrivateFieldSet(this,n,t),this.created=t.created,this.onclose=t.onclose,this.handler=t.handler,this.eventList=t.eventList}return _createClass(StreamEvent,[{key:"delay",get:function get(){return _classPrivateFieldGet(this,n).delay},set:function set(e){_classPrivateFieldGet(this,n).delay="number"==typeof e?e:1e3}},{key:"onProccess",get:function get(){return _classPrivateFieldGet(this,n).onProccess},set:function set(e){_classPrivateFieldGet(this,n).onProccess=e}},{key:"name",get:function get(){return _classPrivateFieldGet(this,n).name}},{key:"repeat",get:function get(){return _classPrivateFieldGet(this,n).repeat}},{key:"remain",get:function get(){return _classPrivateFieldGet(this,n).remainTimes}},{key:"createTime",get:function get(){return _classPrivateFieldGet(this,n).createTime}},{key:"runtime",get:function get(){return _classPrivateFieldGet(this,n).runtime}},{key:"isLoopEvent",get:function get(){return _classPrivateFieldGet(this,n).isLoopEvent}},{key:"data",get:function get(){return function _objectSpread2(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?ownKeys(Object(r),!0).forEach((function(t){_defineProperty(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):ownKeys(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}({},_classPrivateFieldGet(this,n))}},{key:"close",get:function get(){var e=this;return function EventClose(){"function"==typeof e.onclose&&e.onclose(CallbackEvent(e,"closed")),e.onclose=null,_classPrivateFieldGet(e,i).delete(e.name)}}},{key:"decrease",get:function get(){var e=this;return function EventDecrease(t){if(t!==e)throw new Error("EventDecrease should not be excuted manualy.");_classPrivateFieldGet(e,n).remainTimes-=1,!e.isLoopEvent&&e.remain<=0&&e.close()}}},{key:"refresh",get:function get(){var e=this;return function EvnetRefresh(t){if(t!==e)throw new Error("EvnetRefresh should not be excuted manualy.");_classPrivateFieldGet(e,n).runtime+=1,_classPrivateFieldGet(e,n).createTime=_classPrivateFieldGet(e,i).runTime,e.handler||e.eventList.length||e.close()}}},{key:"freeze",get:function get(){var e=this;return function FreezeEvent(){_classPrivateFieldGet(e,n).onProccess=!0}}},{key:"release",get:function get(){var e=this;return function ReleaseEvent(){_classPrivateFieldGet(e,n).onProccess=!1}}}]),StreamEvent}(),o=new WeakMap,s=new WeakMap,l=new WeakMap,c=new WeakMap,u=new WeakMap,f=new WeakSet;function _initPrivateFunctions2(){var e=this;_classPrivateFieldSet(this,c,(function StreamProcess(){_classPrivateFieldSet(e,u,setTimeout((function(){if(!e.stopProccess){_classPrivateFieldGet(e,o).count();var t,r=function _createForOfIteratorHelper(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=_unsupportedIterableToArray(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,F=function(){};return{s:F,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:F}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,a=!0,o=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return a=e.done,e},e:function(e){o=!0,i=e},f:function(){try{a||null==r.return||r.return()}finally{if(o)throw i}}}}(_classPrivateFieldGet(e,s).entries());try{for(r.s();!(t=r.n()).done;){var n=_slicedToArray(t.value,2),i=n[0],a=n[1];a?StreamExcution(a,e):e.delete(i)}}catch(e){r.e(e)}finally{r.f()}StreamProcess()}}),e.delay))})),_classPrivateFieldSet(this,l,(function(t){return _classPrivateFieldGet(e,s).get(t)||{}}))}return function(){function CirnoStream(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:500;_classCallCheck(this,CirnoStream),_classPrivateMethodInitSpec(this,f),_classPrivateFieldInitSpec(this,o,{writable:!0,value:void 0}),_classPrivateFieldInitSpec(this,s,{writable:!0,value:void 0}),_classPrivateFieldInitSpec(this,l,{writable:!0,value:void 0}),_classPrivateFieldInitSpec(this,c,{writable:!0,value:void 0}),_classPrivateFieldInitSpec(this,u,{writable:!0,value:void 0}),this.delay=e,this.stopProccess=!1,_classPrivateFieldSet(this,s,new Map),_classPrivateFieldSet(this,o,new r),_classPrivateMethodGet(this,f,_initPrivateFunctions2).call(this),this.start()}return _createClass(CirnoStream,[{key:"runTime",get:function get(){return _classPrivateFieldGet(this,o).counter}},{key:"changeDelay",value:function changeDelay(e,t){var r=_classPrivateFieldGet(this,l).call(this,e);r&&(r.delay=t)}},{key:"getEvent",value:function getEvent(e){var t;return CallbackEvent(_classPrivateFieldGet(t=_classPrivateFieldGet(this,s),l).call(t,e).data,"get")}},{key:"delete",value:function _delete(e){var t=_classPrivateFieldGet(this,l).call(this,e);if(t)return t&&"function"==typeof t.onclose&&(t.onclose(t),t.onclose=null),_classPrivateFieldGet(this,s).delete(e)}},{key:"on",value:function on(e){var t=_classPrivateFieldGet(this,l).call(this,e);if(t){var r=t.eventList[0]||t.handler;"function"==typeof r&&r(CallbackEvent(t,"forced"))}}},{key:"start",value:function start(e){"number"==typeof e&&(this.delay=e),this.stopProccess=!1,_classPrivateFieldGet(this,c).call(this)}},{key:"pause",value:function pause(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return this.stopProccess=!0,new Promise((function(r){Number(t)>0?setTimeout((function(){e.resume(),r(+new Date)}),t):r()}))}},{key:"resume",value:function resume(e){this.stopProccess&&this.start(e)}},{key:"close",value:function close(){clearTimeout(_classPrivateFieldGet(this,u)),this.stopProccess=!0,_classPrivateFieldGet(this,s).clear()}},{key:"push",value:function push(t,r,n,i){try{var o=function formatAttrs(t,r,n,i,a){var o="function"==typeof t?{handler:t}:Array.isArray(t)?{eventList:t}:t;if("boolean"==typeof r&&(i=r,n="",r=1e3),"boolean"==typeof n&&(i=n,n=""),"string"!=typeof n&&(n=""),"object"!==_typeof(o)||!o)throw new Error("First arguments must be Object, Function, or Array.");var s={name:n||o.name,repeat:o.repeat,onProccess:o.onProccess||!1,createTime:a,runtime:1,remainTimes:parseInt(o.repeat,10),isLoopEvent:!1,delay:"number"==typeof r?r:o.delay||1e3,created:o.created||null,onclose:o.onclose||null,handler:o.handler||null,eventList:Array.isArray(o.eventList)?o.eventList:[]};if("string"!=typeof s.name&&(s.name=e(!0)),"function"!=typeof s.handler&&!s.eventList.length)throw new Error("Property<handler or eventList> of StreamEvent should atleast includes an excutionable Function.");return s.remainTimes=Number.isNaN(s.remainTimes)?1:Math.max(s.remainTimes,0),Array.isArray(t)&&(s.remainTimes=t.length),s.repeat=s.remainTimes,s.isLoopEvent=0===s.repeat,"boolean"==typeof i&&(s.repeat=i?0:s.repeat,s.isLoopEvent=i),s}(t,r,n,i,this.runTime),l=new a(this,o);return _classPrivateFieldGet(this,s).set(l.name,l),"function"==typeof l.created&&(l.created(CallbackEvent(l,"created")),l.created=null),l.name}catch(e){console.error(e)}}}]),CirnoStream}()}));
